{% extends "base.html" %}

{% block title %}Documentation Scraping Dashboard - Lib2DocScrape{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', path='/css/scraping_dashboard.css') }}" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="row">
    <!-- URL Input and Configuration -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Documentation Source</h5>
                <form id="scrapingForm" class="mb-3">
                    <div class="mb-3">
                        <label for="docUrl" class="form-label">Documentation URL or Library Name</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="docUrl" required
                                   placeholder="https://docs.example.com or library-name"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="top"
                                   title="Enter a URL or library name (e.g., 'requests', 'fastapi', 'react')">
                            <button class="btn btn-outline-primary" type="button" id="searchLibraryBtn"
                                    data-bs-toggle="tooltip" title="Search for library documentation">
                                <i class="bi bi-search"></i> Find Docs
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="helpBtn"
                                    data-bs-toggle="modal" data-bs-target="#helpModal">
                                <i class="bi bi-question-circle"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <small>Enter a URL directly or a library name to search for documentation automatically</small>
                        </div>
                    </div>
                    
                    <!-- Library Search Results -->
                    <div id="librarySearchResults" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-search"></i> Found Documentation Sources
                                    <button type="button" class="btn-close float-end" id="closeSearchResults"></button>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="searchResultsList">
                                    <!-- Search results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="backend" class="form-label">Backend Selection</label>
                                <div class="input-group">
                                    <select class="form-select" id="backend" required
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Choose the most appropriate method for your documentation source">
                                        <option value="crawl4ai">Crawl4AI (AI-Powered)</option>
                                        <option value="http" selected>HTTP Backend (Fast & Reliable)</option>
                                        <option value="lightpanda">Lightpanda (JavaScript Support)</option>
                                        <option value="playwright">Playwright (Full Browser)</option>
                                        <option value="scrapy">Scrapy (High Performance)</option>
                                        <option value="file">File Backend (Local Files)</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="benchmarkBtn"
                                            data-bs-toggle="tooltip" title="Compare backend performance">
                                        <i class="bi bi-speedometer2"></i> Benchmark
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small id="backendDescription">Fast and reliable for most documentation sites</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="configPreset" class="form-label">Configuration Preset</label>
                                <div class="input-group">
                                    <select class="form-select" id="configPreset" onchange="updateConfigPreset()">
                                        <option value="default">Default (Balanced)</option>
                                        <option value="comprehensive">Comprehensive (Maximum Coverage)</option>
                                        <option value="performance">Performance (Fast)</option>
                                        <option value="javascript">JavaScript-Optimized</option>
                                        <option value="minimal">Minimal (Testing)</option>
                                        <option value="custom">Custom Configuration</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="savePresetBtn"
                                            data-bs-toggle="tooltip" title="Save current settings as preset">
                                        <i class="bi bi-save"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small id="presetDescription">Balanced configuration for most use cases</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comprehensive Scraping Settings -->
                    <div id="comprehensiveSettings" class="mb-4">
                        <h6 class="text-success"><i class="bi bi-speedometer2"></i> Comprehensive Scraping Configuration</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="scrapingMode" class="form-label">Scraping Mode</label>
                                    <select class="form-select" id="scrapingMode">
                                        <option value="comprehensive">Comprehensive</option>
                                        <option value="fast">Fast</option>
                                        <option value="deep">Deep</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="maxDepth" class="form-label">Max Crawl Depth</label>
                                    <input type="number" class="form-control" id="maxDepth"
                                           value="3" min="1" max="10"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           title="Recommended: 3-4 levels for comprehensive coverage">
                                    <div class="form-text">Recommended: 3-4 levels</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="maxPages" class="form-label">Max Pages per Library</label>
                                    <input type="number" class="form-control" id="maxPages"
                                           value="50" min="5" max="200"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           title="Recommended: 30-50 pages for complete documentation">
                                    <div class="form-text">Recommended: 30-50 pages</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="outputFormat" class="form-label">Output Format</label>
                                    <select class="form-select" id="outputFormat">
                                        <option value="markdown">Markdown (Recommended)</option>
                                        <option value="json">JSON</option>
                                        <option value="html">HTML</option>
                                        <option value="all">All Formats</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="includePatterns" class="form-label">Include URL Patterns (Optional)</label>
                                    <input type="text" class="form-control" id="includePatterns"
                                           placeholder="/docs/, /api/, /guide/"
                                           data-bs-toggle="tooltip"
                                           title="Comma-separated patterns to include">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="excludePatterns" class="form-label">Exclude URL Patterns (Optional)</label>
                                    <input type="text" class="form-control" id="excludePatterns"
                                           placeholder="/search, /login, /_static/"
                                           data-bs-toggle="tooltip"
                                           title="Comma-separated patterns to exclude">
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Processing Options -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="bi bi-gear-fill"></i> Advanced Processing Options</h6>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableQualityCheck" checked>
                                    <label class="form-check-label" for="enableQualityCheck">
                                        Quality Analysis
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableNLP">
                                    <label class="form-check-label" for="enableNLP">
                                        NLP Processing
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableVersionTracking">
                                    <label class="form-check-label" for="enableVersionTracking">
                                        Version Tracking
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createIndex" checked>
                                    <label class="form-check-label" for="createIndex">
                                        Create Index
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createTOC" checked>
                                    <label class="form-check-label" for="createTOC">
                                        Table of Contents
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="groupByTopic">
                                    <label class="form-check-label" for="groupByTopic">
                                        Group by Topic
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extractAssets">
                                    <label class="form-check-label" for="extractAssets">
                                        Extract Assets
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extractCodeBlocks" checked>
                                    <label class="form-check-label" for="extractCodeBlocks">
                                        Extract Code Blocks
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sanitizeContent" checked>
                                    <label class="form-check-label" for="sanitizeContent">
                                        Sanitize Content
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <strong><i class="bi bi-info-circle"></i> Comprehensive Mode:</strong>
                            This mode will scrape 20x more content than basic scrapers. Expect 30-50+ files per library
                            with complete section coverage including user guides, API references, and examples.
                        </div>
                    </div>
                    <!-- Error/Success Messages -->
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary" id="start-scraping-button">
                            Start Scraping
                        </button>
                        <button type="button" id="stopBtn" class="btn btn-danger" disabled>
                            Stop
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scraping Progress -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Scraping Status</h5>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
                <!-- Primary Metrics -->
                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Pages Scraped</h6>
                                <span class="fs-4" id="pages-count">0</span>
                                <small class="d-block" id="pages-rate">0 pages/min</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Success Rate</h6>
                                <span class="fs-4" id="success-rate">0%</span>
                                <small class="d-block" id="success-details">0/0 successful</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Quality Score</h6>
                                <span class="fs-4" id="quality-score">-</span>
                                <small class="d-block" id="quality-details">Analyzing...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Est. Completion</h6>
                                <span class="fs-4" id="est-completion">-</span>
                                <small class="d-block" id="completion-details">Calculating...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="row text-center">
                    <div class="col-md-2">
                        <h6>Current Depth</h6>
                        <span class="badge bg-secondary fs-6" id="depth-count">0</span>
                    </div>
                    <div class="col-md-2">
                        <h6>Content Size</h6>
                        <span class="badge bg-secondary fs-6" id="content-size">0 KB</span>
                    </div>
                    <div class="col-md-2">
                        <h6>Links Found</h6>
                        <span class="badge bg-secondary fs-6" id="links-found">0</span>
                    </div>
                    <div class="col-md-2">
                        <h6>Code Blocks</h6>
                        <span class="badge bg-secondary fs-6" id="code-blocks">0</span>
                    </div>
                    <div class="col-md-2">
                        <h6>Images</h6>
                        <span class="badge bg-secondary fs-6" id="images-found">0</span>
                    </div>
                    <div class="col-md-2">
                        <h6>Backend</h6>
                        <span class="badge bg-secondary fs-6" id="current-backend">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Metrics -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Metrics</h5>
                <div id="metrics-display">
                    <div class="mb-3">
                        <label class="fw-bold">Duration:</label>
                        <span id="duration">00:00:00</span>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Pages/Second:</label>
                        <span id="pages-per-second">0</span>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Memory Usage:</label>
                        <span id="memory-usage">0 MB</span>
                    </div>
                    <div>
                        <label class="fw-bold">CPU Usage:</label>
                        <span id="cpu-usage">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title">Scraping Logs</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm log-level active" data-level="ALL">
                            All
                        </button>
                        <button class="btn btn-outline-info btn-sm log-level" data-level="INFO">
                            Info
                        </button>
                        <button class="btn btn-outline-warning btn-sm log-level" data-level="WARNING">
                            Warning
                        </button>
                        <button class="btn btn-outline-danger btn-sm log-level" data-level="ERROR">
                            Error
                        </button>
                    </div>
                </div>
                <div id="log-viewer" class="bg-dark text-light p-3" style="height: 400px; overflow-y: auto;">
                    <pre><code></code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scraping Results -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Scraping Results</h5>
                <div id="scraping-results" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Content Size</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="no-results" class="text-center text-muted">
                    <p>No scraping results yet. Start a scraping job to see results here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Start Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>1. Enter Documentation URL or Library Name</h6>
                    <p>You can either enter a direct URL or search for a library by name:</p>
                    <ul>
                        <li><strong>Direct URLs:</strong> https://docs.example.com/, https://example.com/documentation/</li>
                        <li><strong>Library Names:</strong> requests, fastapi, react, numpy, pandas</li>
                        <li><strong>GitHub Repos:</strong> user/repo-name</li>
                    </ul>
                    <p>Click "Find Docs" to automatically search for documentation sources!</p>
                </div>
                <div class="mb-4">
                    <h6>2. Choose Scraping Method</h6>
                    <p>Select the appropriate backend based on your needs:</p>
                    <ul>
                        <li><strong>Crawl4AI:</strong> Best for most documentation sites</li>
                        <li><strong>File Backend:</strong> For local documentation files</li>
                    </ul>
                </div>
                <div class="mb-4">
                    <h6>3. Configure Depth</h6>
                    <p>Set how deep the crawler should go:</p>
                    <ul>
                        <li>Lower values (1-3): Quick, shallow scrapes</li>
                        <li>Higher values (4+): Deep, comprehensive scrapes</li>
                    </ul>
                </div>
                <div class="mb-4">
                    <h6>4. Monitor Progress</h6>
                    <p>Use the dashboard to:</p>
                    <ul>
                        <li>Track scraping progress</li>
                        <li>View real-time metrics</li>
                        <li>Monitor logs for issues</li>
                    </ul>
                </div>
                <div>
                    <h6>5. Download Results</h6>
                    <p>When scraping completes, choose your preferred format:</p>
                    <ul>
                        <li>JSON: Raw data for processing</li>
                        <li>Markdown: Human-readable documentation</li>
                        <li>HTML: Web-ready format</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backend Benchmark Modal -->
<div class="modal fade" id="benchmarkModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-speedometer2"></i> Backend Performance Benchmark</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="benchmarkUrl" class="form-label">Test URL</label>
                        <input type="url" class="form-control" id="benchmarkUrl"
                               placeholder="https://docs.python.org/3/">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="startBenchmark()">
                            <i class="bi bi-play-circle"></i> Start Benchmark
                        </button>
                    </div>
                </div>

                <div id="benchmarkProgress" class="d-none">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="benchmarkProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <span id="benchmarkStatus">Preparing benchmark...</span>
                    </div>
                </div>

                <div id="benchmarkResults" class="d-none">
                    <h6>Benchmark Results</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Backend</th>
                                    <th>Speed (s)</th>
                                    <th>Success Rate</th>
                                    <th>Content Size</th>
                                    <th>Memory Usage</th>
                                    <th>Recommendation</th>
                                </tr>
                            </thead>
                            <tbody id="benchmarkTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="benchmarkChart" class="mt-3"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="useBestBackend" onclick="useBestBackend()" disabled>
                    <i class="bi bi-check-circle"></i> Use Best Backend
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Download Options Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download Scraped Documentation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action" id="downloadJson">
                        Download as JSON
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" id="downloadMarkdown">
                        Download as Markdown
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" id="downloadHtml">
                        Download as HTML
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let downloadModal, helpModal;
    const ws = new WebSocketManager('/ws/scraping');
    document.addEventListener('DOMContentLoaded', function() {

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Initialize modals
        downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
        helpModal = new bootstrap.Modal(document.getElementById('helpModal'));

        // Check for URL parameters from quick start
        const urlParams = new URLSearchParams(window.location.search);
        const prefilledUrl = urlParams.get('url');
        const isQuickStart = urlParams.get('quick') === 'true';

        if (prefilledUrl) {
            document.getElementById('docUrl').value = prefilledUrl;
            if (isQuickStart) {
                // Auto-start scraping for quick start
                updateConfigPreset();
                // Focus on the start button
                document.querySelector('button[type="submit"]').focus();
            }
        }

        // Show help modal on first visit (but not for quick start)
        if (!localStorage.getItem('helpShown') && !isQuickStart) {
            helpModal.show();
            localStorage.setItem('helpShown', 'true');
        }

        // Initialize form handling
        initializeScrapingForm();
        initializeLogLevelFiltering();
        initializeDownloadHandlers();
        initializeAdvancedFeatures();
        updateConfigPreset(); // Initialize preset display
    });

    // Configuration presets
    const configPresets = {
        'default': {
            maxDepth: 5,
            maxPages: 100,
            outputFormat: 'markdown',
            description: 'Balanced configuration for most use cases'
        },
        'comprehensive': {
            maxDepth: 3,
            maxPages: 50,
            outputFormat: 'markdown',
            description: 'Maximum coverage with comprehensive scraping'
        },
        'performance': {
            maxDepth: 2,
            maxPages: 20,
            outputFormat: 'markdown',
            description: 'Fast scraping with minimal resource usage'
        },
        'javascript': {
            maxDepth: 4,
            maxPages: 80,
            outputFormat: 'markdown',
            description: 'Optimized for JavaScript-heavy documentation sites'
        },
        'minimal': {
            maxDepth: 2,
            maxPages: 10,
            outputFormat: 'markdown',
            description: 'Quick testing with minimal pages'
        }
    };

    // Backend descriptions
    const backendDescriptions = {
        'http': 'Fast and reliable for most documentation sites',
        'crawl4ai': 'AI-powered crawling with intelligent content extraction',
        'lightpanda': 'JavaScript support for dynamic content',
        'playwright': 'Full browser automation for complex sites',
        'scrapy': 'High-performance crawling for large-scale operations',
        'file': 'Local file system processing'
    };

    function updateConfigPreset() {
        const preset = document.getElementById('configPreset').value;
        const description = document.getElementById('presetDescription');

        if (preset === 'custom') {
            description.textContent = 'Custom configuration - adjust settings manually';
            return;
        }

        const config = configPresets[preset];
        if (config) {
            document.getElementById('maxDepth').value = config.maxDepth;
            document.getElementById('maxPages').value = config.maxPages;
            document.getElementById('outputFormat').value = config.outputFormat;
            description.textContent = config.description;
        }
    }

    function updateBackendDescription() {
        const backend = document.getElementById('backend').value;
        const description = document.getElementById('backendDescription');
        description.textContent = backendDescriptions[backend] || 'Backend description not available';
    }

    function initializeAdvancedFeatures() {
        // Backend selection change handler
        document.getElementById('backend').addEventListener('change', updateBackendDescription);

        // Benchmark button handler
        document.getElementById('benchmarkBtn').addEventListener('click', () => {
            const url = document.getElementById('docUrl').value;
            if (url) {
                document.getElementById('benchmarkUrl').value = url;
            }
            new bootstrap.Modal(document.getElementById('benchmarkModal')).show();
        });

        // Save preset button handler
        document.getElementById('savePresetBtn').addEventListener('click', saveCustomPreset);

        // Library search button handler
        document.getElementById('searchLibraryBtn').addEventListener('click', searchForLibraryDocs);

        // Close search results handler
        document.getElementById('closeSearchResults').addEventListener('click', () => {
            document.getElementById('librarySearchResults').classList.add('d-none');
        });

        // Initialize backend description
        updateBackendDescription();
    }

    async function startBenchmark() {
        const url = document.getElementById('benchmarkUrl').value;
        if (!url) {
            alert('Please enter a URL to benchmark');
            return;
        }

        const progressDiv = document.getElementById('benchmarkProgress');
        const resultsDiv = document.getElementById('benchmarkResults');
        const progressBar = document.getElementById('benchmarkProgressBar');
        const statusSpan = document.getElementById('benchmarkStatus');

        // Show progress, hide results
        progressDiv.classList.remove('d-none');
        resultsDiv.classList.add('d-none');
        progressBar.style.width = '0%';
        statusSpan.textContent = 'Starting benchmark...';

        try {
            const response = await fetch('/api/benchmark/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
                throw new Error('Failed to start benchmark');
            }

            // Simulate benchmark progress
            const backends = ['http', 'crawl4ai', 'lightpanda', 'playwright', 'scrapy'];
            let completed = 0;

            for (const backend of backends) {
                statusSpan.textContent = `Testing ${backend} backend...`;
                progressBar.style.width = `${(completed / backends.length) * 100}%`;

                // Simulate backend testing delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                completed++;
            }

            progressBar.style.width = '100%';
            statusSpan.textContent = 'Analyzing results...';

            // Get benchmark results
            const resultsResponse = await fetch('/api/benchmark/results');
            const results = await resultsResponse.json();

            displayBenchmarkResults(results);

        } catch (error) {
            alert('Error running benchmark: ' + error.message);
            progressDiv.classList.add('d-none');
        }
    }

    function displayBenchmarkResults(results) {
        const progressDiv = document.getElementById('benchmarkProgress');
        const resultsDiv = document.getElementById('benchmarkResults');
        const tableBody = document.getElementById('benchmarkTableBody');

        // Hide progress, show results
        progressDiv.classList.add('d-none');
        resultsDiv.classList.remove('d-none');

        // Clear previous results
        tableBody.innerHTML = '';

        // Mock results for demonstration
        const mockResults = [
            { backend: 'HTTP', speed: 2.3, success: 95, size: '1.2 MB', memory: '45 MB', recommendation: 'Good for static content' },
            { backend: 'Crawl4AI', speed: 4.1, success: 98, size: '1.8 MB', memory: '120 MB', recommendation: 'Best for AI processing' },
            { backend: 'Lightpanda', speed: 3.2, success: 92, size: '1.5 MB', memory: '80 MB', recommendation: 'Good for JavaScript' },
            { backend: 'Playwright', speed: 5.8, success: 99, size: '2.1 MB', memory: '200 MB', recommendation: 'Best for complex sites' },
            { backend: 'Scrapy', speed: 1.9, success: 90, size: '1.1 MB', memory: '35 MB', recommendation: 'Fastest for simple sites' }
        ];

        mockResults.forEach(result => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><strong>${result.backend}</strong></td>
                <td>${result.speed}s</td>
                <td>${result.success}%</td>
                <td>${result.size}</td>
                <td>${result.memory}</td>
                <td><small>${result.recommendation}</small></td>
            `;
        });

        // Enable "Use Best Backend" button
        document.getElementById('useBestBackend').disabled = false;
    }

    function useBestBackend() {
        // Set the best backend (mock: Crawl4AI for demonstration)
        document.getElementById('backend').value = 'crawl4ai';
        updateBackendDescription();

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('benchmarkModal')).hide();

        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <strong>Backend Updated!</strong> Crawl4AI has been selected as the optimal backend for this URL.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
    }

    function saveCustomPreset() {
        const name = prompt('Enter a name for this preset:');
        if (!name) return;

        const preset = {
            maxDepth: parseInt(document.getElementById('maxDepth').value),
            maxPages: parseInt(document.getElementById('maxPages').value),
            outputFormat: document.getElementById('outputFormat').value,
            description: `Custom preset: ${name}`
        };

        // Save to localStorage (in a real app, this would be saved to the server)
        const customPresets = JSON.parse(localStorage.getItem('customPresets') || '{}');
        customPresets[name] = preset;
        localStorage.setItem('customPresets', JSON.stringify(customPresets));

        // Add to select options
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `${name} (Custom)`;
        document.getElementById('configPreset').appendChild(option);

        alert(`Preset "${name}" saved successfully!`);
    }

    function initializeScrapingForm() {
        const form = document.getElementById('scrapingForm');
        const stopBtn = document.getElementById('stopBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                url: document.getElementById('docUrl').value,
                backend: document.getElementById('backend').value,
                mode: document.getElementById('scrapingMode').value,
                maxDepth: parseInt(document.getElementById('maxDepth').value),
                maxPages: parseInt(document.getElementById('maxPages').value),
                outputFormat: document.getElementById('outputFormat').value,
                includePatterns: document.getElementById('includePatterns').value.split(',').map(s => s.trim()).filter(s => s),
                excludePatterns: document.getElementById('excludePatterns').value.split(',').map(s => s.trim()).filter(s => s)
            };

            // Collect advanced processing options
            const advancedOptions = {
                enableQualityCheck: document.getElementById('enableQualityCheck').checked,
                enableNLP: document.getElementById('enableNLP').checked,
                enableVersionTracking: document.getElementById('enableVersionTracking').checked,
                createIndex: document.getElementById('createIndex').checked,
                createTOC: document.getElementById('createTOC').checked,
                groupByTopic: document.getElementById('groupByTopic').checked,
                extractAssets: document.getElementById('extractAssets').checked,
                extractCodeBlocks: document.getElementById('extractCodeBlocks').checked
            };

            // Show loading state
            showLoading();
            hideErrorMessage();
            
            try {
                const response = await fetch('/crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: formData.url,
                        backend: formData.backend,
                        max_depth: formData.maxDepth,
                        max_pages: formData.maxPages,
                        output_format: formData.outputFormat,
                        include_patterns: formData.includePatterns,
                        exclude_patterns: formData.excludePatterns,
                        advanced_options: advancedOptions
                    })
                });

                hideLoading();
                
                if (response.ok) {
                    const result = await response.json();
                    form.querySelector('button[type="submit"]').disabled = true;
                    stopBtn.disabled = false;
                    showSuccessMessage('Scraping started successfully!');
                    showScrapingResults(result);
                } else {
                    const error = await response.json();
                    showErrorMessage(`Error: ${error.detail || error.message || 'Failed to start scraping'}`);
                }
            } catch (error) {
                hideLoading();
                showErrorMessage('Network error: Unable to connect to the server');
                console.error(error);
            }
        });

        stopBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to stop the scraping process?')) {
                try {
                    await fetch('/api/scraping/stop', { method: 'POST' });
                    form.querySelector('button[type="submit"]').disabled = false;
                    stopBtn.disabled = true;
                } catch (error) {
                    alert('Error stopping scraping process');
                    console.error(error);
                }
            }
        });
    }

    function initializeLogLevelFiltering() {
        document.querySelectorAll('.log-level').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.log-level').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                ws.send({
                    type: 'log_filter',
                    level: button.getAttribute('data-level')
                });
            });
        });
    }

    function initializeDownloadHandlers() {
        ['Json', 'Markdown', 'Html'].forEach(format => {
            document.getElementById(`download${format}`).addEventListener('click', () => {
                downloadResults(format.toLowerCase());
            });
        });
    }

    async function downloadResults(format) {
        try {
            const response = await fetch(`/api/scraping/download/${format}`);
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `documentation.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('Error downloading results');
            }
        } catch (error) {
            alert('Error downloading results');
            console.error(error);
        }
    }

    // WebSocket Event Handlers
    ws.on('scraping_progress', data => {
        const { completed, total } = data;
        const percentage = Math.round((completed / total) * 100) || 0;
        document.querySelector('.progress-bar').style.width = `${percentage}%`;
        document.querySelector('.progress-bar').textContent = `${percentage}%`;
    });

    ws.on('metrics', data => {
        Object.entries(data).forEach(([key, value]) => {
            const element = document.getElementById(key.replace(/_/g, '-'));
            if (element) {
                element.textContent = value;
            }
        });
    });

    ws.on('log', data => {
        const logViewer = document.querySelector('#log-viewer code');
        const logEntry = `<span class="log-${data.level}">[${data.timestamp}] [${data.level}] ${data.message}</span>\n`;
        logViewer.innerHTML += logEntry;
        logViewer.parentElement.scrollTop = logViewer.parentElement.scrollHeight;
    });

    ws.on('scraping_complete', () => {
        document.getElementById('scrapingForm').querySelector('button[type="submit"]').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        downloadModal.show();
    });

    // Helper functions for UI updates
    function showErrorMessage(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
        hideSuccessMessage();
    }

    function hideErrorMessage() {
        document.getElementById('error-message').classList.add('d-none');
    }

    function showSuccessMessage(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.classList.remove('d-none');
        hideErrorMessage();
    }

    function hideSuccessMessage() {
        document.getElementById('success-message').classList.add('d-none');
    }

    function showScrapingResults(result) {
        const resultsDiv = document.getElementById('scraping-results');
        const noResultsDiv = document.getElementById('no-results');
        const tableBody = document.getElementById('results-table-body');
        
        // Show results section
        resultsDiv.classList.remove('d-none');
        noResultsDiv.classList.add('d-none');
        
        // Add result to table
        if (result && result.status === 'success') {
            const row = tableBody.insertRow(0); // Insert at top
            row.innerHTML = `
                <td>${result.url || 'N/A'}</td>
                <td><span class="badge bg-success">Success</span></td>
                <td>${result.content_size || 'N/A'}</td>
                <td>${new Date().toLocaleString()}</td>
            `;
        }
    }

    async function searchForLibraryDocs() {
        const input = document.getElementById('docUrl').value.trim();
        if (!input) {
            showErrorMessage('Please enter a library name or URL to search');
            return;
        }

        // Check if it's already a URL
        if (input.startsWith('http://') || input.startsWith('https://')) {
            showSuccessMessage('URL detected - ready to scrape directly');
            return;
        }

        // Show loading state
        const searchBtn = document.getElementById('searchLibraryBtn');
        const originalText = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Searching...';
        searchBtn.disabled = true;

        try {
            const response = await fetch('/discover', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inputs: [input] })
            });

            if (!response.ok) {
                throw new Error(`Search failed: ${response.status}`);
            }

            const data = await response.json();
            displayLibrarySearchResults(data.urls || {}, input);

        } catch (error) {
            showErrorMessage(`Search failed: ${error.message}`);
            console.error('Library search error:', error);
        } finally {
            // Restore button state
            searchBtn.innerHTML = originalText;
            searchBtn.disabled = false;
        }
    }

    function displayLibrarySearchResults(urls, searchTerm) {
        const resultsDiv = document.getElementById('librarySearchResults');
        const resultsList = document.getElementById('searchResultsList');

        if (Object.keys(urls).length === 0) {
            resultsList.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    No documentation found for "${searchTerm}". Try a different search term or enter a URL directly.
                </div>
            `;
            resultsDiv.classList.remove('d-none');
            return;
        }

        // Create results HTML
        let resultsHTML = `
            <div class="mb-3">
                <strong>Found ${Object.keys(urls).length} documentation source(s) for "${searchTerm}":</strong>
            </div>
        `;

        Object.entries(urls).forEach(([url, info], index) => {
            const source = info.source || 'Unknown';
            const isRecommended = index === 0; // First result is recommended
            
            resultsHTML += `
                <div class="card mb-2 ${isRecommended ? 'border-primary' : ''}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="fw-bold">
                                    ${url}
                                    ${isRecommended ? '<span class="badge bg-primary ms-2">Recommended</span>' : ''}
                                </div>
                                <small class="text-muted">Source: ${source}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectLibraryUrl('${url}')">
                                <i class="bi bi-check-circle"></i> Use This
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        resultsList.innerHTML = resultsHTML;
        resultsDiv.classList.remove('d-none');
        
        // Show success message
        showSuccessMessage(`Found ${Object.keys(urls).length} documentation sources! Select one to continue.`);
    }

    function selectLibraryUrl(url) {
        // Set the selected URL in the input field
        document.getElementById('docUrl').value = url;
        
        // Hide the search results
        document.getElementById('librarySearchResults').classList.add('d-none');
        
        // Show success message
        showSuccessMessage(`Selected: ${url} - Ready to start scraping!`);
        
        // Focus on the start button
        document.getElementById('start-scraping-button').focus();
    }
</script>
{% endblock %}